{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-2xl font-semibold mb-4">
    Quiz Results – {{ quiz.title }}
  </h1>

  <div class="mb-6 flex justify-between items-center">
    <a
      href="{% url 'quiz:quiz_edit' quiz.id %}"
      class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
    >
      ← Back to Quiz
    </a>

    <!-- Filter Buttons -->
    <div class="flex gap-2">
      <a href="?filter=all" 
         class="px-4 py-2 rounded {% if filter_type == 'all' %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        All ({{ total_attempts }})
      </a>
      <a href="?filter=completed" 
         class="px-4 py-2 rounded {% if filter_type == 'completed' %}bg-green-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        Completed
      </a>
      <a href="?filter=top" 
         class="px-4 py-2 rounded {% if filter_type == 'top' %}bg-purple-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        Top Scores
      </a>
      <a href="?filter=lowest" 
         class="px-4 py-2 rounded {% if filter_type == 'lowest' %}bg-orange-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        Lowest Scores
      </a>
      <a href="?filter=active" 
         class="px-4 py-2 rounded {% if filter_type == 'active' %}bg-yellow-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        Active
      </a>
      <a href="?filter=disqualified" 
         class="px-4 py-2 rounded {% if filter_type == 'disqualified' %}bg-red-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">
        Disqualified
      </a>
    </div>
  </div>

  <div class="border rounded overflow-x-auto">
    <table class="w-full border-collapse text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-3 text-left">Team Code</th>
          <th class="p-3 text-left">Email</th>
          <th class="p-3 text-center">Attempt</th>
          <th class="p-3 text-center">Status</th>
          <th class="p-3 text-center">Score</th>
          <th class="p-3 text-center">Percentage</th>
          <th class="p-3 text-center">Correct</th>
          <th class="p-3 text-center">Wrong</th>
          <th class="p-3 text-center">Unanswered</th>
          <th class="p-3 text-center">Warnings</th>
          <th class="p-3 text-center">Fullscreen</th>
          <th class="p-3 text-center">DevTools</th>
          <th class="p-3 text-center">Started</th>
          <th class="p-3 text-center">Ended</th>
          <th class="p-3 text-center">Duration</th>
        </tr>
      </thead>
      <tbody>
        {% for data in attempts_with_scores %}
        <tr class="border-t hover:bg-gray-50">
          <td class="p-3 font-medium">
            {{ data.attempt.team_code }}
          </td>
          <td class="p-3">
            {{ data.attempt.team_lead_email }}
          </td>
          <td class="p-3 text-center">
            {{ data.attempt.attempt_number }}
          </td>
          <td class="p-3 text-center">
            {% if data.attempt.status == "submitted" %}
              <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">Submitted</span>
            {% elif data.attempt.status == "auto_submitted" %}
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Auto</span>
            {% elif data.attempt.status == "disqualified" %}
              <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">Disqualified</span>
            {% else %}
              <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Active</span>
            {% endif %}
          </td>
          <td class="p-3 text-center font-semibold">
            {{ data.score }}/{{ data.total }}
          </td>
          <td class="p-3 text-center">
            <span class="{% if data.percentage >= 80 %}text-green-600{% elif data.percentage >= 50 %}text-blue-600{% else %}text-red-600{% endif %} font-semibold">
              {{ data.percentage }}%
            </span>
          </td>
          <td class="p-3 text-center text-green-600">
            {{ data.correct }}
          </td>
          <td class="p-3 text-center text-red-600">
            {{ data.wrong }}
          </td>
          <td class="p-3 text-center text-gray-600">
            {{ data.unanswered }}
          </td>
          <td class="p-3 text-center">
            {{ data.attempt.warnings_used }}
          </td>
          <td class="p-3 text-center">
            {{ data.attempt.fullscreen_violations }}
          </td>
          <td class="p-3 text-center">
            {{ data.attempt.devtools_violations }}
          </td>
          <td class="p-3 text-center text-gray-600 text-xs">
            {{ data.attempt.started_at|date:"Y-m-d H:i" }}
          </td>
          <td class="p-3 text-center text-gray-600 text-xs">
            {% if data.attempt.ended_at %}
              {{ data.attempt.ended_at|date:"Y-m-d H:i" }}
            {% else %}
              <span class="text-yellow-600">In Progress</span>
            {% endif %}
          </td>
          <td class="p-3 text-center text-gray-600">
            {% if data.attempt.ended_at %}
              {% widthratio data.attempt.ended_at|timesince:data.attempt.started_at 1 1 %}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="15" class="p-4 text-center text-gray-500">
            No attempts found for this filter.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Summary Stats -->
  {% if attempts_with_scores %}
  <div class="mt-6 grid grid-cols-4 gap-4">
    <div class="bg-white border rounded p-4">
      <div class="text-sm text-gray-600">Total Attempts</div>
      <div class="text-2xl font-bold">{{ total_attempts }}</div>
    </div>
    <div class="bg-white border rounded p-4">
      <div class="text-sm text-gray-600">Average Score</div>
      <div class="text-2xl font-bold text-blue-600">
        {% widthratio attempts_with_scores|length 1 1 %}%
      </div>
    </div>
    <div class="bg-white border rounded p-4">
      <div class="text-sm text-gray-600">Highest Score</div>
      <div class="text-2xl font-bold text-green-600">
        {% for data in attempts_with_scores %}
          {% if forloop.first %}{{ data.percentage }}%{% endif %}
        {% endfor %}
      </div>
    </div>
    <div class="bg-white border rounded p-4">
      <div class="text-sm text-gray-600">Lowest Score</div>
      <div class="text-2xl font-bold text-red-600">
        {% for data in attempts_with_scores %}
          {% if forloop.last %}{{ data.percentage }}%{% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
